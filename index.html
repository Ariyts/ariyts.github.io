import React, { useState, useMemo, useEffect, useRef } from "react";

/*
  Personal Knowledge Hub ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π single-file React component
  - TailwindCSS —É—Ç–∏–ª–∏—Ç—ã
  - –ù—É–∂–Ω—ã –≤–Ω–µ—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –ø–æ–ª–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ (—É–∫–∞–∑–∞–Ω—ã –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö)
  - –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –∫–∞–∫ —à–∞–±–ª–æ–Ω: –±–µ—Ä—ë—Ç–µ, –≤—Å—Ç–∞–≤–ª—è–µ—Ç–µ –≤ CRA/Vite + Tailwind –∏ –¥–æ–ø–∏–ª–∏–≤–∞–µ—Ç–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏.

  –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ (–ø–æ –∂–µ–ª–∞–Ω–∏—é):
    npm i marked highlight.js dayjs file-saver

  –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ "–ø–æ –º–∞–∫—Å–∏–º—É–º—É":
    ‚Ä¢ –¢—ë–º–Ω–∞—è/—Å–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ + –∞–≤—Ç–æ-–ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞
    ‚Ä¢ –ü–æ–∏—Å–∫, —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ —Ç–µ–≥–∞–º –∏ —Å–µ–∫—Ü–∏—è–º
    ‚Ä¢ Markdown-—Ä–µ–¥–∞–∫—Ç–æ—Ä —Å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç `marked` –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ)
    ‚Ä¢ –≠–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç –∑–∞–º–µ—Ç–æ–∫ –≤ JSON/Markdown/CSV
    ‚Ä¢ –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (localStorage) + —Ä—É—á–Ω–æ–π –±—ç–∫–∞–ø/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
    ‚Ä¢ –ö–∞–ª–µ–Ω–¥–∞—Ä—å (–ø—Ä–æ—Å—Ç–æ–π view) –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (placeholder –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Google Calendar)
    ‚Ä¢ –ö–∞–Ω–±–∞–Ω-–¥–æ—Å–∫–∞ –¥–ª—è –∑–∞–¥–∞—á (drag & drop placeholder)
    ‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞–º–∏ –∑–∞–º–µ—Ç–æ–∫, –±—ã—Å—Ç—Ä—ã–µ –≤—Å—Ç–∞–≤–∫–∏
    ‚Ä¢ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å GitHub / Notion ‚Äî —Ç–æ–ª—å–∫–æ UI + –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (—Ç—Ä–µ–±—É–µ—Ç —Å–µ—Ä–≤–µ—Ä/—Ç–æ–∫–µ–Ω—ã)
    ‚Ä¢ –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–¥–∞ —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π (highlight.js placeholder)
    ‚Ä¢ –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ (–º–µ—Ç–∞-–¥–∞–Ω–Ω—ã–µ –≤ localStorage)
    ‚Ä¢ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF (placeholder), —ç–∫—Å–ø–æ—Ä—Ç —á–µ—Ä–µ–∑ FileSaver
    ‚Ä¢ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
    ‚Ä¢ –ü—Ä–æ—Å—Ç–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–º–µ—Ç–æ–∫/–ø—Ä–æ–µ–∫—Ç–æ–≤)

  –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –º–Ω–æ–≥–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Ç—Ä–µ–±—É—é—Ç backend / OAuth ‚Äî –≤ —à–∞–±–ª–æ–Ω–µ —ç—Ç–æ –ø–æ–º–µ—á–µ–Ω–æ –∫–∞–∫ TODO.
*/

// –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ markdown-—Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `marked` –∏ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∏–º–ø–æ—Ä—Ç –Ω–∏–∂–µ
// import { marked } from 'marked';
// import hljs from 'highlight.js';
// import dayjs from 'dayjs';
// import { saveAs } from 'file-saver';

export default function PersonalKnowledgeHub() {
  // UI state
  const [query, setQuery] = useState("");
  const [dark, setDark] = useState(() => localStorage.getItem("pkh:dark") === "1");
  const [activeSection, setActiveSection] = useState("overview");
  const [selectedTags, setSelectedTags] = useState([]);
  const [showSettings, setShowSettings] = useState(false);
  
  // Utilities
  const genId = () => Math.random().toString(36).slice(2, 9);

  // Data state ‚Äî notes/bookmarks/projects/todos stored in localStorage
  const [data, setData] = useState(() => {
    try {
      const raw = localStorage.getItem("pkh:data");
      if (raw) return JSON.parse(raw);
    } catch (e) {
      console.error("Failed to parse data from localStorage", e);
    }
    // default seed data
    return {
      overview: { title: "–û–±–∑–æ—Ä", items: [
        { id: genId(), title: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!", content: "–≠—Ç–æ –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ü–µ–Ω—Ç—Ä –∑–Ω–∞–Ω–∏–π. –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∑–∞–º–µ—Ç–∫–∏, –∑–∞–¥–∞—á–∏, –∑–∞–∫–ª–∞–¥–∫–∏ –∏ –ø—Ä–æ–µ–∫—Ç—ã.", tags: ["welcome"], createdAt: new Date().toISOString() }
      ] },
      bookmarks: { title: "–ó–∞–∫–ª–∞–¥–∫–∏", items: [] },
      notes: { title: "–ó–∞–º–µ—Ç–∫–∏", items: [] },
      projects: { title: "–ü—Ä–æ–µ–∫—Ç—ã", items: [] },
      // –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω –ø—Ä–∏–º–µ—Ä –∑–∞–¥–∞—á–∏ —Å –¥–∞—Ç–æ–π –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
      tasks: { title: "–ó–∞–¥–∞—á–∏", items: [
        { id: genId(), title: "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å Notion", content: "–ü–æ–¥–∫–ª—é—á–∏—Ç—å API –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∑–∞–º–µ—Ç–æ–∫.", tags: ["integration", "api"], status: "todo", date: new Date().toISOString().slice(0, 10) }
      ] },
    };
  });

  // Editor state
  const [editing, setEditing] = useState(null); // {section, id} or null
  const [editorContent, setEditorContent] = useState("");
  const [editorTitle, setEditorTitle] = useState("");
  const [editorTags, setEditorTags] = useState("");
  const fileInputRef = useRef(null);

  // Derived
  const sections = useMemo(() => Object.keys(data).map((k) => ({ id: k, label: data[k].title || k })), [data]);

  useEffect(() => {
    localStorage.setItem("pkh:dark", dark ? "1" : "0");
    if (dark) {
        document.documentElement.classList.add('dark');
    } else {
        document.documentElement.classList.remove('dark');
    }
  }, [dark]);

  useEffect(() => {
    try {
      localStorage.setItem("pkh:data", JSON.stringify(data));
    } catch (e) {
      console.warn("Saving failed", e);
    }
  }, [data]);

  const allItems = useMemo(() => {
    return Object.entries(data).flatMap(([sectionKey, sectionObj]) =>
      (sectionObj.items || []).map((it) => ({ ...it, _section: sectionKey, _sectionTitle: sectionObj.title }))
    );
  }, [data]);

  // Search + filters
  const filteredItems = useMemo(() => {
    const q = query.trim().toLowerCase();
    return allItems.filter((it) => {
      if (selectedTags.length > 0 && !selectedTags.every((t) => (it.tags || []).includes(t))) return false;
      if (!q) return true;
      return (it.title + " " + (it.desc || "") + " " + (it.content || "") + " " + (it.tags || []).join(" ")).toLowerCase().includes(q);
    });
  }, [query, allItems, selectedTags]);

  // Tags list
  const tags = useMemo(() => {
    const s = new Set();
    allItems.forEach((it) => (it.tags || []).forEach((t) => s.add(t)));
    return Array.from(s).sort();
  }, [allItems]);

  // Editing flows
  function openEditor(section, item = null) {
    setActiveSection(section);
    if (item) {
      setEditing({ section, id: item.id });
      setEditorTitle(item.title || "");
      setEditorContent(item.content || item.desc || "");
      setEditorTags((item.tags || []).join(", "));
    } else {
      // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID —Å—Ä–∞–∑—É –¥–ª—è –Ω–æ–≤–æ–π –∑–∞–º–µ—Ç–∫–∏, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ø—Ä–∏–∫—Ä–µ–ø–ª—è—Ç—å —Ñ–∞–π–ª—ã –¥–æ –ø–µ—Ä–≤–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
      const newId = genId();
      setEditing({ section, id: newId });
      setEditorTitle("");
      setEditorContent("");
      setEditorTags("");
    }
  }

  function saveEditor() {
    if (!editing) return;
    const { section, id } = editing;

    const updatedItem = {
      id,
      title: editorTitle || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",
      desc: editorContent.slice(0, 200),
      content: editorContent,
      tags: editorTags.split(",").map((t) => t.trim()).filter(Boolean),
      updatedAt: new Date().toISOString(),
    };

    setData((prev) => {
      const newData = { ...prev };
      const currentSection = newData[section] || { title: section, items: [] };
      const items = currentSection.items || [];
      const itemIndex = items.findIndex((x) => x.id === id);

      let newItems;
      if (itemIndex >= 0) {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç, —Å–æ—Ö—Ä–∞–Ω—è—è –µ–≥–æ —Å—Ç–∞—Ä—ã–µ –ø–æ–ª—è, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, createdAt)
        newItems = items.map((it, index) => index === itemIndex ? { ...items[itemIndex], ...updatedItem } : it);
      } else {
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
        newItems = [{ ...updatedItem, createdAt: new Date().toISOString() }, ...items];
      }
      
      newData[section] = { ...currentSection, items: newItems };
      return newData;
    });

    setEditing(null);
  }


  function deleteItem(section, id) {
    if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç?")) return;
    setData((prev) => {
      const copy = { ...prev };
      copy[section] = { ...copy[section], items: (copy[section].items || []).filter((x) => x.id !== id) };
      return copy;
    });
  }

  // –ò–°–ü–†–ê–í–õ–ï–ù–û: –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–∞ –¥–ª—è –∏–º–º—É—Ç–∞–±–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
  function handleAttachFile(ev, section, id) {
    const files = ev.target.files;
    if (!files || files.length === 0) return;
    
    const newAttachments = Array.from(files).map(f => ({
      name: f.name,
      size: f.size,
      type: f.type,
      addedAt: new Date().toISOString()
    }));

    setData(prev => {
        const newData = { ...prev };
        const sectionItems = (newData[section]?.items || []);
        const itemIndex = sectionItems.findIndex(x => x.id === id);

        // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –µ—â–µ –Ω–µ –±—ã–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω, –æ–Ω –Ω–µ –±—É–¥–µ—Ç –Ω–∞–π–¥–µ–Ω. 
        // –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –º—ã –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, —Ç.–∫. —Ñ–∞–π–ª –±—É–¥–µ—Ç –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.
        // –ù–æ —Å –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–æ–π `openEditor` –æ–Ω –≤—Å–µ–≥–¥–∞ –±—É–¥–µ—Ç –Ω–∞–π–¥–µ–Ω.
        if (itemIndex === -1) {
            console.warn("Item not found for attachment. This shouldn't happen.");
            return prev;
        }

        const updatedItems = [...sectionItems];
        const oldItem = updatedItems[itemIndex];
        const updatedItem = {
            ...oldItem,
            attachments: [...(oldItem.attachments || []), ...newAttachments]
        };
        updatedItems[itemIndex] = updatedItem;

        newData[section] = { ...newData[section], items: updatedItems };
        
        return newData;
    });
    // –û—á–∏—â–∞–µ–º input, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤—ã–±—Ä–∞—Ç—å —Ç–æ—Ç –∂–µ —Ñ–∞–π–ª —Å–Ω–æ–≤–∞
    if (fileInputRef.current) {
        fileInputRef.current.value = "";
    }
  }


  // Export / Import
  function exportJSON() {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `pkh-backup-${new Date().toISOString().slice(0, 10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function importJSON(ev) {
    const f = ev.target.files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const obj = JSON.parse(e.target.result);
        if (confirm("–ó–∞–º–µ–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ? (–û—Ç–º–µ–Ω–∞ ‚Äî –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å —Å —Ç–µ–∫—É—â–∏–º–∏)")) {
          setData(obj);
        } else {
          // simple merge
          setData((prev) => ({ ...prev, ...obj }));
        }
        alert("–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω");
      } catch (e) {
        alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞.");
      }
    };
    reader.readAsText(f);
  }

  // Quick add
  function quickAdd(section) {
    const title = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ:");
    if (!title) return;
    const it = { id: genId(), title, desc: "", content: "", tags: [], createdAt: new Date().toISOString() };
    setData((prev) => {
      const copy = { ...prev };
      copy[section] = { ...(copy[section] || { title: section, items: [] }), items: [it, ...(copy[section].items || [])] };
      return copy;
    });
  }

  // Simple statistics
  const stats = useMemo(() => {
    const total = allItems.length;
    const bySection = Object.fromEntries(Object.keys(data).map((k) => [k, (data[k].items || []).length]));
    return { total, bySection };
  }, [allItems, data]);

  // Keyboard shortcuts (basic)
  useEffect(() => {
    function onKey(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === "k") {
        e.preventDefault();
        const qel = document.getElementById("pkh:search");
        if (qel) qel.focus();
      }
      if ((e.ctrlKey || e.metaKey) && e.key === "b") {
        e.preventDefault();
        setDark((d) => !d);
      }
      if (e.key === "Escape" && (editing || showSettings)) {
        e.preventDefault();
        setEditing(null);
        setShowSettings(false);
      }
    }
    window.addEventListener("keydown", onKey);
    return () => window.removeEventListener("keydown", onKey);
  }, [editing, showSettings]);

  // Small Markdown preview helper (naive) ‚Äî if marked is installed, use it
  function renderMarkdown(md) {
    // If `marked` exists globally, prefer it (user will install and uncomment import)
    // @ts-ignore
    if (window.marked) return window.marked.parse(md || "");
    // very naive: convert newlines to <br> and simple **bold**
    const escaped = (md || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    const bolded = escaped.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
    const lines = bolded.split(/\n\n+/g).map((p) => `<p>${p.replace(/\n/g, "<br />")}</p>`);
    return lines.join("");
  }

  // UI pieces
  return (
    <div className={dark ? "min-h-screen bg-gray-900 text-gray-100" : "min-h-screen bg-gray-50 text-gray-900"}>
      <div className="max-w-7xl mx-auto p-4">
        <header className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-indigo-500 to-emerald-500 flex items-center justify-center font-bold text-white">PK</div>
            <div>
              <h1 className="text-lg font-semibold">Personal Knowledge Hub</h1>
              <p className="text-sm opacity-70">–í—Å—ë, —á—Ç–æ –Ω—É–∂–Ω–æ ‚Äî –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ</p>
            </div>
          </div>

          <div className="flex items-center gap-3">
            <div className="hidden sm:block">
              <input
                id="pkh:search"
                value={query}
                onChange={(e) => setQuery(e.target.value)}
                placeholder="Ctrl/Cmd+K ‚Äî –ø–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –∑–∞–º–µ—Ç–∫–∞–º"
                className={
                  "w-80 rounded-md border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 " + (dark ? "bg-gray-800 border-gray-700" : "bg-white border-gray-200")
                }
              />
            </div>
            <div className="flex items-center gap-2">
              <button onClick={() => setShowSettings((s) => !s)} className="px-3 py-2 rounded-md border text-sm">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
              <button onClick={() => { setDark((s)=>!s); }} className="px-3 py-2 rounded-md border text-sm">{dark ? "–°–≤–µ—Ç–ª–∞—è" : "–¢—ë–º–Ω–∞—è"}</button>
              <div className="hidden md:block text-xs opacity-70 px-2">–ó–∞–º–µ—Ç–æ–∫: {stats.total}</div>
            </div>
          </div>
        </header>

        <div className="grid grid-cols-1 md:grid-cols-5 gap-6">
          {/* Sidebar */}
          <aside className={"md:col-span-1 rounded-lg p-4 " + (dark ? "bg-gray-800" : "bg-white shadow")}>
            <div className="mb-4">
              <div className="flex items-center justify-between mb-2">
                <strong>–†–∞–∑–¥–µ–ª—ã</strong>
                <button className="text-xs opacity-80 hover:opacity-100" onClick={() => quickAdd(activeSection)}>–ë—ã—Å—Ç—Ä–æ +</button>
              </div>
              <nav className="flex flex-col gap-2">
                {sections.map((s) => (
                  <button
                    key={s.id}
                    onClick={() => { setActiveSection(s.id); setQuery(''); }}
                    className={
                      "text-left px-3 py-2 rounded-md w-full text-sm font-medium transition-colors " +
                      (activeSection === s.id && !query
                        ? (dark ? "bg-emerald-700 text-white" : "bg-emerald-100 text-emerald-800")
                        : (dark ? "hover:bg-gray-700" : "hover:bg-gray-100"))
                    }
                  >
                    {s.label} <span className="text-xs opacity-60 ml-2">({(data[s.id]?.items||[]).length})</span>
                  </button>
                ))}
              </nav>
            </div>

            <div className="mb-4">
              <strong>–¢–µ–≥–∏</strong>
              <div className="mt-2 flex flex-wrap gap-2">
                {tags.length === 0 && <div className="text-sm opacity-60">–ù–µ—Ç —Ç–µ–≥–æ–≤</div>}
                {tags.map((t) => (
                  <button
                    key={t}
                    onClick={() => setSelectedTags((st) => st.includes(t) ? st.filter(x => x!==t) : [...st, t])}
                    className={"text-xs px-2 py-1 rounded-full border transition-colors " + (selectedTags.includes(t) ? "bg-emerald-600 border-emerald-600 text-white" : "hover:bg-gray-200 dark:hover:bg-gray-700")}
                  >
                    #{t}
                  </button>
                ))}
              </div>
            </div>

            <div className="mb-4">
              <strong>–ë—ã—Å—Ç—Ä—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</strong>
              <div className="mt-2 flex flex-col gap-2 text-sm">
                <button onClick={exportJSON} className="px-3 py-2 rounded-md border text-left">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
                <label className="px-3 py-2 rounded-md border text-left cursor-pointer">
                  –ò–º–ø–æ—Ä—Ç JSON
                  <input type="file" accept="application/json" onChange={importJSON} className="hidden" />
                </label>
                <button onClick={() => { if(confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) { localStorage.removeItem('pkh:data'); window.location.reload(); } }} className="px-3 py-2 rounded-md border text-left text-red-500">–°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö (–ª–æ–∫–∞–ª—å–Ω–æ)</button>
              </div>
            </div>

            <div className="mt-4 border-t pt-3 text-sm opacity-80">
              <div className="mb-2">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</div>
              <ul className="flex flex-col gap-2 list-disc list-inside">
                <li>Google Calendar ‚Äî TODO (OAuth)</li>
                <li>GitHub ‚Äî UI –¥–ª—è sync (requires token/ backend)</li>
                <li>Notion / Obsidian ‚Äî export/import Markdown</li>
              </ul>
            </div>
          </aside>

          {/* Main content */}
          <main className="md:col-span-4">
            {/* Top controls */}
            <div className="mb-4 flex items-center justify-between gap-3">
              <div className="flex items-center gap-2">
                <button onClick={() => openEditor(activeSection, null)} className="px-3 py-2 rounded-md border bg-emerald-600 text-white hover:bg-emerald-700">–°–æ–∑–¥–∞—Ç—å</button>
                <select value={activeSection} onChange={(e)=>setActiveSection(e.target.value)} className={"px-3 py-2 rounded-md border text-sm " + (dark ? "bg-gray-800 border-gray-700" : "bg-white")}>
                  {sections.map(s => <option key={s.id} value={s.id}>{s.label}</option>)}
                </select>
              </div>
            </div>

            {/* Editor */}
            {editing ? (
              <section className={"rounded-lg p-4 mb-4 " + (dark ? "bg-gray-800" : "bg-white shadow")}>
                <div className="flex items-center justify-between mb-3">
                  <div>
                    <input value={editorTitle} onChange={(e)=>setEditorTitle(e.target.value)} placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" className="text-lg font-medium w-full bg-transparent outline-none" />
                    <div className="text-xs opacity-60">–†–∞–∑–¥–µ–ª: {editing.section}</div>
                  </div>
                  <div className="flex gap-2">
                    <label className="px-3 py-2 border rounded-md cursor-pointer text-sm">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª<input ref={fileInputRef} onChange={(e) => handleAttachFile(e, editing.section, editing.id)} type="file" multiple className="hidden"/></label>
                    <button onClick={()=>{ setEditing(null); }} className="px-3 py-2 border rounded-md text-sm">–û—Ç–º–µ–Ω–∞</button>
                    <button onClick={saveEditor} className="px-3 py-2 bg-emerald-600 text-white rounded-md text-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <textarea value={editorContent} onChange={(e)=>setEditorContent(e.target.value)} placeholder="–¢–µ–ª–æ –∑–∞–º–µ—Ç–∫–∏ (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ Markdown)" className={"w-full min-h-[180px] rounded-md border p-3 bg-transparent focus:outline-none focus:ring-2 focus:ring-emerald-500 " + (dark?"border-gray-700":"border-gray-200")}></textarea>
                  <div className={"prose prose-sm dark:prose-invert max-w-none rounded-md border p-3 min-h-[180px] overflow-auto " + (dark?"border-gray-700":"border-gray-200")}>
                    <div dangerouslySetInnerHTML={{__html: renderMarkdown(editorContent)}} />
                  </div>
                </div>

                <div className="mt-3 flex items-center gap-2">
                  <input value={editorTags} onChange={(e)=>setEditorTags(e.target.value)} placeholder="—Ç–µ–≥1, —Ç–µ–≥2" className={"px-3 py-2 rounded-md border w-full md:w-1/2 text-sm " + (dark ? "bg-gray-900 border-gray-700" : "bg-white")} />
                </div>
              </section>
            ) : null}

            {/* If search active ‚Äî show results */}
            {query || selectedTags.length > 0 ? (
              <section className={"rounded-lg p-4 " + (dark ? "bg-gray-800" : "bg-white shadow")}>
                <h2 className="text-base font-semibold mb-3">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</h2>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  {filteredItems.length === 0 && <div className="text-sm opacity-70 col-span-full">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>}
                  {filteredItems.map((it) => (
                    <article key={it.id} className={"p-3 rounded-md border " + (dark ? "border-gray-700" : "border-gray-200")}>
                      <div className="flex justify-between items-start">
                        <h3 className="font-medium">{it.title}</h3>
                        <span className="text-xs opacity-70 whitespace-nowrap">{it._sectionTitle}</span>
                      </div>
                      <p className="text-sm opacity-80 mt-2 line-clamp-3">{it.desc || it.content}</p>
                      <div className="mt-3 flex flex-wrap gap-2">
                        {(it.tags || []).map((t) => (
                          <span key={t} className="text-xs px-2 py-1 rounded-full border opacity-80">#{t}</span>
                        ))}
                      </div>
                      <div className="mt-3 flex gap-2">
                        <button onClick={()=>openEditor(it._section, it)} className="text-sm px-3 py-1 rounded-md border">–û—Ç–∫—Ä—ã—Ç—å</button>
                        <button onClick={()=>deleteItem(it._section, it.id)} className="text-sm px-3 py-1 rounded-md border">–£–¥–∞–ª–∏—Ç—å</button>
                      </div>
                    </article>
                  ))}
                </div>
              </section>
            ) : (
              // Default view ‚Äî active section
              <section className={"rounded-lg p-4 " + (dark ? "bg-gray-800" : "bg-white shadow")}>
                <div className="flex items-center justify-between mb-3">
                  <h2 className="text-base font-semibold">{data[activeSection]?.title || activeSection}</h2>
                  <div className="text-sm opacity-60">{(data[activeSection]?.items||[]).length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤</div>
                </div>

                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                  {(data[activeSection]?.items || []).map((it) => (
                    <article key={it.id} className={"p-3 rounded-md border flex flex-col justify-between " + (dark ? "border-gray-700" : "border-gray-200")}>
                      <div>
                        <h3 className="font-medium">{it.title}</h3>
                        <div className="text-xs opacity-60">{it.updatedAt ? new Date(it.updatedAt).toLocaleString() : (it.createdAt ? new Date(it.createdAt).toLocaleString() : '')}</div>
                        <p className="text-sm opacity-80 mt-2 line-clamp-4">{it.desc || it.content?.slice(0,200)}</p>
                        <div className="mt-3 flex flex-wrap gap-2">
                          {(it.tags || []).map((t) => (
                            <span key={t} className="text-xs px-2 py-1 rounded-full border opacity-80">#{t}</span>
                          ))}
                        </div>
                      </div>
                      <div className="mt-3 flex gap-2">
                        <button onClick={()=>openEditor(activeSection, it)} className="text-sm px-3 py-1 rounded-md border">–û—Ç–∫—Ä—ã—Ç—å</button>
                        <button onClick={()=>deleteItem(activeSection, it.id)} className="text-sm px-3 py-1 rounded-md border">–£–¥–∞–ª–∏—Ç—å</button>
                        <button onClick={()=>{ navigator.clipboard.writeText(it.content||it.desc||''); alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä'); }} className="text-sm px-3 py-1 rounded-md border">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                      </div>
                    </article>
                  ))}
                </div>
              </section>
            )}

            {/* Extras: simple kanban / calendar placeholders */}
            <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className={"rounded-lg p-4 " + (dark ? "bg-gray-800" : "bg-white shadow")}>
                <div className="flex items-center justify-between mb-3">
                  <strong>–ö–∞–Ω–±–∞–Ω (—á–µ—Ä–Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è)</strong>
                  <div className="text-xs opacity-60">Drag&drop ‚Äî TODO</div>
                </div>
                <div className="grid grid-cols-3 gap-3 text-sm">
                  {/* –ò–°–ü–†–ê–í–õ–ï–ù–û: –õ–æ–≥–∏–∫–∞ –ø–æ–¥—Å—á–µ—Ç–∞ –∑–∞–¥–∞—á */}
                  <div className="p-2 border rounded">TODO<br/><b>{(data.tasks?.items||[]).filter(t=>!t.status || t.status === 'todo').length}</b></div>
                  <div className="p-2 border rounded">–í –ø—Ä–æ—Ü–µ—Å—Å–µ<br/><b>{(data.tasks?.items||[]).filter(t=>t.status==='inprogress').length}</b></div>
                  <div className="p-2 border rounded">–ì–æ—Ç–æ–≤–æ<br/><b>{(data.tasks?.items||[]).filter(t=>t.status==='done').length}</b></div>
                </div>
              </div>

              <div className={"rounded-lg p-4 " + (dark ? "bg-gray-800" : "bg-white shadow")}>
                <div className="flex items-center justify-between mb-3">
                  <strong>–ö–∞–ª–µ–Ω–¥–∞—Ä—å (–º–∏–∫—Ä–æ-–≤–∏–¥)</strong>
                  <div className="text-xs opacity-60">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏: Google Calendar ‚Äî TODO</div>
                </div>
                <div className="text-sm opacity-70">–°–µ–≥–æ–¥–Ω—è: {new Date().toLocaleDateString()}</div>
                <ul className="mt-2 text-sm space-y-1">
                  {allItems.filter(it=>it.date).slice(0,5).map(it => (
                    <li key={it.id} className="truncate">üóìÔ∏è {it.date} ‚Äî {it.title}</li>
                  ))}
                  {allItems.filter(it=>it.date).length === 0 && <li className="opacity-60">–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π —Å –¥–∞—Ç–∞–º–∏.</li>}
                </ul>
              </div>
            </div>

            {/* Footer */}
            <div className="mt-6 text-center text-sm opacity-80">–®–∞–±–ª–æ–Ω: —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è ‚Äî –¥–æ–±–∞–≤–∏–º —ç–∫—Å–ø–æ—Ä—Ç –≤ PDF, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å GitHub –∏ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ –∑–∞–ø—Ä–æ—Å—É.</div>
          </main>
        </div>

        {/* Settings modal (simple) */}
        {showSettings && (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
            <div className="absolute inset-0" onClick={()=>setShowSettings(false)} />
            <div className={"relative max-w-2xl w-full rounded-lg p-6 shadow-xl " + (dark?"bg-gray-800 text-gray-100":"bg-white text-gray-900")}>
              <h3 className="text-lg font-semibold mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
              <div className="grid grid-cols-1 gap-3">
                <label className="flex items-center gap-2 cursor-pointer"><input type="checkbox" checked={dark} onChange={(e)=>setDark(e.target.checked)} /> –¢—ë–º–Ω–∞—è —Ç–µ–º–∞</label>
                <label className="flex items-center gap-2 cursor-pointer"><input type="checkbox" disabled /> –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ highlight.js)</label>
                <div className="text-sm opacity-70 mt-2">–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏: Ctrl/Cmd+K ‚Äî –ø–æ–∏—Å–∫, Ctrl/Cmd+B ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É, Esc ‚Äî –∑–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–∞.</div>
                <div className="flex gap-2 mt-4 border-t pt-4">
                  <button onClick={()=>{ exportJSON(); alert('–≠–∫—Å–ø–æ—Ä—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); }} className="px-3 py-2 rounded-md border text-sm">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
                  <button onClick={()=>{ navigator.clipboard.writeText(JSON.stringify(data)); alert('JSON-–¥–∞–Ω–Ω—ã–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä'); }} className="px-3 py-2 rounded-md border text-sm">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                  <button onClick={()=>setShowSettings(false)} className="px-3 py-2 rounded-md border text-sm ml-auto">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}