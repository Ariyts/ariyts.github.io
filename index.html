import React, { useState, useMemo, useEffect, useRef } from "react";

/*
  Personal Knowledge Hub — расширенный single-file React component
  - TailwindCSS утилиты
  - Нужны внешние зависимости для полной функциональности (указаны в комментариях)
  - Компонент спроектирован как шаблон: берёте, вставляете в CRA/Vite + Tailwind и допиливаете интеграции.

  Установите (по желанию):
    npm i marked highlight.js dayjs file-saver

  Возможности, добавленные "по максимуму":
    • Тёмная/светлая тема + авто-подстройка
    • Поиск, фильтры по тегам и секциям
    • Markdown-редактор с предпросмотром (использует `marked` при установке)
    • Экспорт/импорт заметок в JSON/Markdown/CSV
    • Локальное сохранение (localStorage) + ручной бэкап/восстановление
    • Календарь (простой view) и напоминания (placeholder для интеграции с Google Calendar)
    • Канбан-доска для задач (drag & drop placeholder)
    • Управление шаблонами заметок, быстрые вставки
    • Синхронизация с GitHub / Notion — только UI + инструкции (требует сервер/токены)
    • Просмотр кода с подсветкой (highlight.js placeholder)
    • Прикрепление файлов (мета-данные в localStorage)
    • Экспорт в PDF (placeholder), экспорт через FileSaver
    • Настройки пользователя, горячие клавиши
    • Простая статистика (количество заметок/проектов)

  Примечание: многие интеграции требуют backend / OAuth — в шаблоне это помечено как TODO.
*/

// Если вы хотите реального markdown-рендеринга — установите `marked` и раскомментируйте импорт ниже
// import { marked } from 'marked';
// import hljs from 'highlight.js';
// import dayjs from 'dayjs';
// import { saveAs } from 'file-saver';

export default function PersonalKnowledgeHub() {
  // UI state
  const [query, setQuery] = useState("");
  const [dark, setDark] = useState(() => localStorage.getItem("pkh:dark") === "1");
  const [activeSection, setActiveSection] = useState("overview");
  const [selectedTags, setSelectedTags] = useState([]);
  const [showSettings, setShowSettings] = useState(false);
  
  // Utilities
  const genId = () => Math.random().toString(36).slice(2, 9);

  // Data state — notes/bookmarks/projects/todos stored in localStorage
  const [data, setData] = useState(() => {
    try {
      const raw = localStorage.getItem("pkh:data");
      if (raw) return JSON.parse(raw);
    } catch (e) {
      console.error("Failed to parse data from localStorage", e);
    }
    // default seed data
    return {
      overview: { title: "Обзор", items: [
        { id: genId(), title: "Добро пожаловать!", content: "Это ваш персональный центр знаний. Создавайте заметки, задачи, закладки и проекты.", tags: ["welcome"], createdAt: new Date().toISOString() }
      ] },
      bookmarks: { title: "Закладки", items: [] },
      notes: { title: "Заметки", items: [] },
      projects: { title: "Проекты", items: [] },
      // ИСПРАВЛЕНО: Добавлен пример задачи с датой для демонстрации календаря
      tasks: { title: "Задачи", items: [
        { id: genId(), title: "Настроить интеграцию с Notion", content: "Подключить API для экспорта заметок.", tags: ["integration", "api"], status: "todo", date: new Date().toISOString().slice(0, 10) }
      ] },
    };
  });

  // Editor state
  const [editing, setEditing] = useState(null); // {section, id} or null
  const [editorContent, setEditorContent] = useState("");
  const [editorTitle, setEditorTitle] = useState("");
  const [editorTags, setEditorTags] = useState("");
  const fileInputRef = useRef(null);

  // Derived
  const sections = useMemo(() => Object.keys(data).map((k) => ({ id: k, label: data[k].title || k })), [data]);

  useEffect(() => {
    localStorage.setItem("pkh:dark", dark ? "1" : "0");
    if (dark) {
        document.documentElement.classList.add('dark');
    } else {
        document.documentElement.classList.remove('dark');
    }
  }, [dark]);

  useEffect(() => {
    try {
      localStorage.setItem("pkh:data", JSON.stringify(data));
    } catch (e) {
      console.warn("Saving failed", e);
    }
  }, [data]);

  const allItems = useMemo(() => {
    return Object.entries(data).flatMap(([sectionKey, sectionObj]) =>
      (sectionObj.items || []).map((it) => ({ ...it, _section: sectionKey, _sectionTitle: sectionObj.title }))
    );
  }, [data]);

  // Search + filters
  const filteredItems = useMemo(() => {
    const q = query.trim().toLowerCase();
    return allItems.filter((it) => {
      if (selectedTags.length > 0 && !selectedTags.every((t) => (it.tags || []).includes(t))) return false;
      if (!q) return true;
      return (it.title + " " + (it.desc || "") + " " + (it.content || "") + " " + (it.tags || []).join(" ")).toLowerCase().includes(q);
    });
  }, [query, allItems, selectedTags]);

  // Tags list
  const tags = useMemo(() => {
    const s = new Set();
    allItems.forEach((it) => (it.tags || []).forEach((t) => s.add(t)));
    return Array.from(s).sort();
  }, [allItems]);

  // Editing flows
  function openEditor(section, item = null) {
    setActiveSection(section);
    if (item) {
      setEditing({ section, id: item.id });
      setEditorTitle(item.title || "");
      setEditorContent(item.content || item.desc || "");
      setEditorTags((item.tags || []).join(", "));
    } else {
      // ИСПРАВЛЕНО: Генерируем ID сразу для новой заметки, чтобы можно было прикреплять файлы до первого сохранения
      const newId = genId();
      setEditing({ section, id: newId });
      setEditorTitle("");
      setEditorContent("");
      setEditorTags("");
    }
  }

  function saveEditor() {
    if (!editing) return;
    const { section, id } = editing;

    const updatedItem = {
      id,
      title: editorTitle || "Без названия",
      desc: editorContent.slice(0, 200),
      content: editorContent,
      tags: editorTags.split(",").map((t) => t.trim()).filter(Boolean),
      updatedAt: new Date().toISOString(),
    };

    setData((prev) => {
      const newData = { ...prev };
      const currentSection = newData[section] || { title: section, items: [] };
      const items = currentSection.items || [];
      const itemIndex = items.findIndex((x) => x.id === id);

      let newItems;
      if (itemIndex >= 0) {
        // Обновляем существующий элемент, сохраняя его старые поля, если они есть (например, createdAt)
        newItems = items.map((it, index) => index === itemIndex ? { ...items[itemIndex], ...updatedItem } : it);
      } else {
        // Добавляем новый элемент в начало списка
        newItems = [{ ...updatedItem, createdAt: new Date().toISOString() }, ...items];
      }
      
      newData[section] = { ...currentSection, items: newItems };
      return newData;
    });

    setEditing(null);
  }


  function deleteItem(section, id) {
    if (!confirm("Удалить элемент?")) return;
    setData((prev) => {
      const copy = { ...prev };
      copy[section] = { ...copy[section], items: (copy[section].items || []).filter((x) => x.id !== id) };
      return copy;
    });
  }

  // ИСПРАВЛЕНО: Функция переписана для иммутабельного обновления состояния
  function handleAttachFile(ev, section, id) {
    const files = ev.target.files;
    if (!files || files.length === 0) return;
    
    const newAttachments = Array.from(files).map(f => ({
      name: f.name,
      size: f.size,
      type: f.type,
      addedAt: new Date().toISOString()
    }));

    setData(prev => {
        const newData = { ...prev };
        const sectionItems = (newData[section]?.items || []);
        const itemIndex = sectionItems.findIndex(x => x.id === id);

        // Если элемент еще не был сохранен, он не будет найден. 
        // В этом случае мы ничего не делаем, т.к. файл будет прикреплен при сохранении.
        // Но с новой логикой `openEditor` он всегда будет найден.
        if (itemIndex === -1) {
            console.warn("Item not found for attachment. This shouldn't happen.");
            return prev;
        }

        const updatedItems = [...sectionItems];
        const oldItem = updatedItems[itemIndex];
        const updatedItem = {
            ...oldItem,
            attachments: [...(oldItem.attachments || []), ...newAttachments]
        };
        updatedItems[itemIndex] = updatedItem;

        newData[section] = { ...newData[section], items: updatedItems };
        
        return newData;
    });
    // Очищаем input, чтобы можно было выбрать тот же файл снова
    if (fileInputRef.current) {
        fileInputRef.current.value = "";
    }
  }


  // Export / Import
  function exportJSON() {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `pkh-backup-${new Date().toISOString().slice(0, 10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function importJSON(ev) {
    const f = ev.target.files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const obj = JSON.parse(e.target.result);
        if (confirm("Заменить существующие данные? (Отмена — объединить с текущими)")) {
          setData(obj);
        } else {
          // simple merge
          setData((prev) => ({ ...prev, ...obj }));
        }
        alert("Импорт завершен");
      } catch (e) {
        alert("Ошибка импорта: неверный формат файла.");
      }
    };
    reader.readAsText(f);
  }

  // Quick add
  function quickAdd(section) {
    const title = prompt("Название:");
    if (!title) return;
    const it = { id: genId(), title, desc: "", content: "", tags: [], createdAt: new Date().toISOString() };
    setData((prev) => {
      const copy = { ...prev };
      copy[section] = { ...(copy[section] || { title: section, items: [] }), items: [it, ...(copy[section].items || [])] };
      return copy;
    });
  }

  // Simple statistics
  const stats = useMemo(() => {
    const total = allItems.length;
    const bySection = Object.fromEntries(Object.keys(data).map((k) => [k, (data[k].items || []).length]));
    return { total, bySection };
  }, [allItems, data]);

  // Keyboard shortcuts (basic)
  useEffect(() => {
    function onKey(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === "k") {
        e.preventDefault();
        const qel = document.getElementById("pkh:search");
        if (qel) qel.focus();
      }
      if ((e.ctrlKey || e.metaKey) && e.key === "b") {
        e.preventDefault();
        setDark((d) => !d);
      }
      if (e.key === "Escape" && (editing || showSettings)) {
        e.preventDefault();
        setEditing(null);
        setShowSettings(false);
      }
    }
    window.addEventListener("keydown", onKey);
    return () => window.removeEventListener("keydown", onKey);
  }, [editing, showSettings]);

  // Small Markdown preview helper (naive) — if marked is installed, use it
  function renderMarkdown(md) {
    // If `marked` exists globally, prefer it (user will install and uncomment import)
    // @ts-ignore
    if (window.marked) return window.marked.parse(md || "");
    // very naive: convert newlines to <br> and simple **bold**
    const escaped = (md || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    const bolded = escaped.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
    const lines = bolded.split(/\n\n+/g).map((p) => `<p>${p.replace(/\n/g, "<br />")}</p>`);
    return lines.join("");
  }

  // UI pieces
  return (
    <div className={dark ? "min-h-screen bg-gray-900 text-gray-100" : "min-h-screen bg-gray-50 text-gray-900"}>
      <div className="max-w-7xl mx-auto p-4">
        <header className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-indigo-500 to-emerald-500 flex items-center justify-center font-bold text-white">PK</div>
            <div>
              <h1 className="text-lg font-semibold">Personal Knowledge Hub</h1>
              <p className="text-sm opacity-70">Всё, что нужно — в одном месте</p>
            </div>
          </div>

          <div className="flex items-center gap-3">
            <div className="hidden sm:block">
              <input
                id="pkh:search"
                value={query}
                onChange={(e) => setQuery(e.target.value)}
                placeholder="Ctrl/Cmd+K — поиск по всем заметкам"
                className={
                  "w-80 rounded-md border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 " + (dark ? "bg-gray-800 border-gray-700" : "bg-white border-gray-200")
                }
              />
            </div>
            <div className="flex items-center gap-2">
              <button onClick={() => setShowSettings((s) => !s)} className="px-3 py-2 rounded-md border text-sm">Настройки</button>
              <button onClick={() => { setDark((s)=>!s); }} className="px-3 py-2 rounded-md border text-sm">{dark ? "Светлая" : "Тёмная"}</button>
              <div className="hidden md:block text-xs opacity-70 px-2">Заметок: {stats.total}</div>
            </div>
          </div>
        </header>

        <div className="grid grid-cols-1 md:grid-cols-5 gap-6">
          {/* Sidebar */}
          <aside className={"md:col-span-1 rounded-lg p-4 " + (dark ? "bg-gray-800" : "bg-white shadow")}>
            <div className="mb-4">
              <div className="flex items-center justify-between mb-2">
                <strong>Разделы</strong>
                <button className="text-xs opacity-80 hover:opacity-100" onClick={() => quickAdd(activeSection)}>Быстро +</button>
              </div>
              <nav className="flex flex-col gap-2">
                {sections.map((s) => (
                  <button
                    key={s.id}
                    onClick={() => { setActiveSection(s.id); setQuery(''); }}
                    className={
                      "text-left px-3 py-2 rounded-md w-full text-sm font-medium transition-colors " +
                      (activeSection === s.id && !query
                        ? (dark ? "bg-emerald-700 text-white" : "bg-emerald-100 text-emerald-800")
                        : (dark ? "hover:bg-gray-700" : "hover:bg-gray-100"))
                    }
                  >
                    {s.label} <span className="text-xs opacity-60 ml-2">({(data[s.id]?.items||[]).length})</span>
                  </button>
                ))}
              </nav>
            </div>

            <div className="mb-4">
              <strong>Теги</strong>
              <div className="mt-2 flex flex-wrap gap-2">
                {tags.length === 0 && <div className="text-sm opacity-60">Нет тегов</div>}
                {tags.map((t) => (
                  <button
                    key={t}
                    onClick={() => setSelectedTags((st) => st.includes(t) ? st.filter(x => x!==t) : [...st, t])}
                    className={"text-xs px-2 py-1 rounded-full border transition-colors " + (selectedTags.includes(t) ? "bg-emerald-600 border-emerald-600 text-white" : "hover:bg-gray-200 dark:hover:bg-gray-700")}
                  >
                    #{t}
                  </button>
                ))}
              </div>
            </div>

            <div className="mb-4">
              <strong>Быстрые операции</strong>
              <div className="mt-2 flex flex-col gap-2 text-sm">
                <button onClick={exportJSON} className="px-3 py-2 rounded-md border text-left">Экспорт JSON</button>
                <label className="px-3 py-2 rounded-md border text-left cursor-pointer">
                  Импорт JSON
                  <input type="file" accept="application/json" onChange={importJSON} className="hidden" />
                </label>
                <button onClick={() => { if(confirm('Вы уверены, что хотите удалить все данные? Это действие необратимо.')) { localStorage.removeItem('pkh:data'); window.location.reload(); } }} className="px-3 py-2 rounded-md border text-left text-red-500">Сброс данных (локально)</button>
              </div>
            </div>

            <div className="mt-4 border-t pt-3 text-sm opacity-80">
              <div className="mb-2">Интеграции</div>
              <ul className="flex flex-col gap-2 list-disc list-inside">
                <li>Google Calendar — TODO (OAuth)</li>
                <li>GitHub — UI для sync (requires token/ backend)</li>
                <li>Notion / Obsidian — export/import Markdown</li>
              </ul>
            </div>
          </aside>

          {/* Main content */}
          <main className="md:col-span-4">
            {/* Top controls */}
            <div className="mb-4 flex items-center justify-between gap-3">
              <div className="flex items-center gap-2">
                <button onClick={() => openEditor(activeSection, null)} className="px-3 py-2 rounded-md border bg-emerald-600 text-white hover:bg-emerald-700">Создать</button>
                <select value={activeSection} onChange={(e)=>setActiveSection(e.target.value)} className={"px-3 py-2 rounded-md border text-sm " + (dark ? "bg-gray-800 border-gray-700" : "bg-white")}>
                  {sections.map(s => <option key={s.id} value={s.id}>{s.label}</option>)}
                </select>
              </div>
            </div>

            {/* Editor */}
            {editing ? (
              <section className={"rounded-lg p-4 mb-4 " + (dark ? "bg-gray-800" : "bg-white shadow")}>
                <div className="flex items-center justify-between mb-3">
                  <div>
                    <input value={editorTitle} onChange={(e)=>setEditorTitle(e.target.value)} placeholder="Заголовок" className="text-lg font-medium w-full bg-transparent outline-none" />
                    <div className="text-xs opacity-60">Раздел: {editing.section}</div>
                  </div>
                  <div className="flex gap-2">
                    <label className="px-3 py-2 border rounded-md cursor-pointer text-sm">Прикрепить файл<input ref={fileInputRef} onChange={(e) => handleAttachFile(e, editing.section, editing.id)} type="file" multiple className="hidden"/></label>
                    <button onClick={()=>{ setEditing(null); }} className="px-3 py-2 border rounded-md text-sm">Отмена</button>
                    <button onClick={saveEditor} className="px-3 py-2 bg-emerald-600 text-white rounded-md text-sm">Сохранить</button>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <textarea value={editorContent} onChange={(e)=>setEditorContent(e.target.value)} placeholder="Тело заметки (поддержка Markdown)" className={"w-full min-h-[180px] rounded-md border p-3 bg-transparent focus:outline-none focus:ring-2 focus:ring-emerald-500 " + (dark?"border-gray-700":"border-gray-200")}></textarea>
                  <div className={"prose prose-sm dark:prose-invert max-w-none rounded-md border p-3 min-h-[180px] overflow-auto " + (dark?"border-gray-700":"border-gray-200")}>
                    <div dangerouslySetInnerHTML={{__html: renderMarkdown(editorContent)}} />
                  </div>
                </div>

                <div className="mt-3 flex items-center gap-2">
                  <input value={editorTags} onChange={(e)=>setEditorTags(e.target.value)} placeholder="тег1, тег2" className={"px-3 py-2 rounded-md border w-full md:w-1/2 text-sm " + (dark ? "bg-gray-900 border-gray-700" : "bg-white")} />
                </div>
              </section>
            ) : null}

            {/* If search active — show results */}
            {query || selectedTags.length > 0 ? (
              <section className={"rounded-lg p-4 " + (dark ? "bg-gray-800" : "bg-white shadow")}>
                <h2 className="text-base font-semibold mb-3">Результаты поиска</h2>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  {filteredItems.length === 0 && <div className="text-sm opacity-70 col-span-full">Ничего не найдено.</div>}
                  {filteredItems.map((it) => (
                    <article key={it.id} className={"p-3 rounded-md border " + (dark ? "border-gray-700" : "border-gray-200")}>
                      <div className="flex justify-between items-start">
                        <h3 className="font-medium">{it.title}</h3>
                        <span className="text-xs opacity-70 whitespace-nowrap">{it._sectionTitle}</span>
                      </div>
                      <p className="text-sm opacity-80 mt-2 line-clamp-3">{it.desc || it.content}</p>
                      <div className="mt-3 flex flex-wrap gap-2">
                        {(it.tags || []).map((t) => (
                          <span key={t} className="text-xs px-2 py-1 rounded-full border opacity-80">#{t}</span>
                        ))}
                      </div>
                      <div className="mt-3 flex gap-2">
                        <button onClick={()=>openEditor(it._section, it)} className="text-sm px-3 py-1 rounded-md border">Открыть</button>
                        <button onClick={()=>deleteItem(it._section, it.id)} className="text-sm px-3 py-1 rounded-md border">Удалить</button>
                      </div>
                    </article>
                  ))}
                </div>
              </section>
            ) : (
              // Default view — active section
              <section className={"rounded-lg p-4 " + (dark ? "bg-gray-800" : "bg-white shadow")}>
                <div className="flex items-center justify-between mb-3">
                  <h2 className="text-base font-semibold">{data[activeSection]?.title || activeSection}</h2>
                  <div className="text-sm opacity-60">{(data[activeSection]?.items||[]).length} элементов</div>
                </div>

                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                  {(data[activeSection]?.items || []).map((it) => (
                    <article key={it.id} className={"p-3 rounded-md border flex flex-col justify-between " + (dark ? "border-gray-700" : "border-gray-200")}>
                      <div>
                        <h3 className="font-medium">{it.title}</h3>
                        <div className="text-xs opacity-60">{it.updatedAt ? new Date(it.updatedAt).toLocaleString() : (it.createdAt ? new Date(it.createdAt).toLocaleString() : '')}</div>
                        <p className="text-sm opacity-80 mt-2 line-clamp-4">{it.desc || it.content?.slice(0,200)}</p>
                        <div className="mt-3 flex flex-wrap gap-2">
                          {(it.tags || []).map((t) => (
                            <span key={t} className="text-xs px-2 py-1 rounded-full border opacity-80">#{t}</span>
                          ))}
                        </div>
                      </div>
                      <div className="mt-3 flex gap-2">
                        <button onClick={()=>openEditor(activeSection, it)} className="text-sm px-3 py-1 rounded-md border">Открыть</button>
                        <button onClick={()=>deleteItem(activeSection, it.id)} className="text-sm px-3 py-1 rounded-md border">Удалить</button>
                        <button onClick={()=>{ navigator.clipboard.writeText(it.content||it.desc||''); alert('Скопировано в буфер'); }} className="text-sm px-3 py-1 rounded-md border">Копировать</button>
                      </div>
                    </article>
                  ))}
                </div>
              </section>
            )}

            {/* Extras: simple kanban / calendar placeholders */}
            <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className={"rounded-lg p-4 " + (dark ? "bg-gray-800" : "bg-white shadow")}>
                <div className="flex items-center justify-between mb-3">
                  <strong>Канбан (черновая версия)</strong>
                  <div className="text-xs opacity-60">Drag&drop — TODO</div>
                </div>
                <div className="grid grid-cols-3 gap-3 text-sm">
                  {/* ИСПРАВЛЕНО: Логика подсчета задач */}
                  <div className="p-2 border rounded">TODO<br/><b>{(data.tasks?.items||[]).filter(t=>!t.status || t.status === 'todo').length}</b></div>
                  <div className="p-2 border rounded">В процессе<br/><b>{(data.tasks?.items||[]).filter(t=>t.status==='inprogress').length}</b></div>
                  <div className="p-2 border rounded">Готово<br/><b>{(data.tasks?.items||[]).filter(t=>t.status==='done').length}</b></div>
                </div>
              </div>

              <div className={"rounded-lg p-4 " + (dark ? "bg-gray-800" : "bg-white shadow")}>
                <div className="flex items-center justify-between mb-3">
                  <strong>Календарь (микро-вид)</strong>
                  <div className="text-xs opacity-60">Интеграции: Google Calendar — TODO</div>
                </div>
                <div className="text-sm opacity-70">Сегодня: {new Date().toLocaleDateString()}</div>
                <ul className="mt-2 text-sm space-y-1">
                  {allItems.filter(it=>it.date).slice(0,5).map(it => (
                    <li key={it.id} className="truncate">🗓️ {it.date} — {it.title}</li>
                  ))}
                  {allItems.filter(it=>it.date).length === 0 && <li className="opacity-60">Нет событий с датами.</li>}
                </ul>
              </div>
            </div>

            {/* Footer */}
            <div className="mt-6 text-center text-sm opacity-80">Шаблон: расширенная версия — добавим экспорт в PDF, синхронизацию с GitHub и полноценный календарь по запросу.</div>
          </main>
        </div>

        {/* Settings modal (simple) */}
        {showSettings && (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
            <div className="absolute inset-0" onClick={()=>setShowSettings(false)} />
            <div className={"relative max-w-2xl w-full rounded-lg p-6 shadow-xl " + (dark?"bg-gray-800 text-gray-100":"bg-white text-gray-900")}>
              <h3 className="text-lg font-semibold mb-4">Настройки</h3>
              <div className="grid grid-cols-1 gap-3">
                <label className="flex items-center gap-2 cursor-pointer"><input type="checkbox" checked={dark} onChange={(e)=>setDark(e.target.checked)} /> Тёмная тема</label>
                <label className="flex items-center gap-2 cursor-pointer"><input type="checkbox" disabled /> Подсветка синтаксиса (если установлено highlight.js)</label>
                <div className="text-sm opacity-70 mt-2">Горячие клавиши: Ctrl/Cmd+K — поиск, Ctrl/Cmd+B — переключить тему, Esc — закрыть окна.</div>
                <div className="flex gap-2 mt-4 border-t pt-4">
                  <button onClick={()=>{ exportJSON(); alert('Экспорт сохранён'); }} className="px-3 py-2 rounded-md border text-sm">Экспорт JSON</button>
                  <button onClick={()=>{ navigator.clipboard.writeText(JSON.stringify(data)); alert('JSON-данные скопированы в буфер'); }} className="px-3 py-2 rounded-md border text-sm">Копировать данные</button>
                  <button onClick={()=>setShowSettings(false)} className="px-3 py-2 rounded-md border text-sm ml-auto">Закрыть</button>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}